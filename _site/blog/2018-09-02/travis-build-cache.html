<!DOCTYPE html>
<html lang="en">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    restic &middot;
      
        Enabling the Go Build Cache on Travis/AppVeyor
      
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/css/others.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
  <!-- Canonical URL -->
  <link rel="canonical" href="https://restic.net/blog/2018-09-02/travis-build-cache" />

  <!-- scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">restic</a>
      </h1>
      <p class="lead">Backups done right!</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>
      

      
        
      
        
          
            <a class="sidebar-nav-item" href="/blog/">Blog</a>
          
        
      
        
          
        
      
        
      

      <a class="sidebar-nav-item" href="https://forum.restic.net/">Forum</a>
      <a class="sidebar-nav-item" href="https://restic.readthedocs.io/en/stable/">Docs</a>
      <a class="sidebar-nav-item" href="https://restic.readthedocs.io/en/latest/">Docs (dev)</a>

      <a class="sidebar-nav-item" href="https://github.com/restic/restic">
        <i class="fa fa-github" aria-hidden="true"></i>
        GitHub Project
      </a>

      <a class="sidebar-nav-item" href="https://twitter.com/resticbackup">
        <i class="fa fa-twitter" aria-hidden="true"></i>
        @<span class="username">resticbackup</span>
      </a>
    </nav>

    <nav class="sidebar-nav secondary-nav">
      
    </nav>

    <!--<p>&copy; 2019. All rights reserved.</p>-->
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Enabling the Go Build Cache on Travis/AppVeyor</h1>
  <span class="post-date">02 Sep 2018</span>
  <p>The restic project runs the unit and integration tests for each pushed commit
and each pull request. We’re using <a href="https://travis-ci.com">Travis CI</a> for Linux
and OS X, and <a href="https://www.appveyor.com/">AppVeyor</a> for Windows. We’re very
grateful that they provide their services free of charge for Open Source
projects!</p>

<p>Our project not only runs the tests on Travis, but also compiles restic for
each supported architecture, operating system, and version of Go. Go is known
for its fast compilation times, but still, compilation takes its time. Roughly,
for each version of Go, running all the tests takes between 13 and 25 minutes:</p>

<p><img src="/assets/travis-ci-before-build-cache.png" alt="Build Times on Travis CI Before Caching Build Cache" /></p>

<p>With the release of Go 1.10, a build cache was
<a href="https://golang.org/doc/go1.10#build">introduced</a>, which saves compiled
artifacts in a cache directory. On Linux, that’s usually located in
<code class="highlighter-rouge">~/.cache/go-build</code>. So when the same package (with the same build tags and
architecture and so on) is to be compiled again, the Go compiler can just use
the cached version.</p>

<p>Travis executes the tests in a fresh container each time they are run, but we
can <a href="https://docs.travis-ci.com/user/caching/">tell it</a> to keep the build cache
directory and extract it before the tests are run next time. The entry in the
configuration file <code class="highlighter-rouge">.travis.yml</code> looks like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">cache</span><span class="pi">:</span>
  <span class="na">directories</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">$HOME/.cache/go-build</span>
    <span class="pi">-</span> <span class="s">$HOME/gopath/pkg/mod</span>
</code></pre></div></div>

<p>This also caches another directory in the GOPATH called <code class="highlighter-rouge">pkg/mod</code>, which contains
information about released modules. This is a feature introduced with Go 1.11.</p>

<p>The directories listed above work for Linux, but the Go build cache directory
is somewhere else on OS X, so we need to add the cache entries to our build
matrix:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">matrix</span><span class="pi">:</span>
  <span class="na">include</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">go</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.9.x"</span>
      <span class="na">cache</span><span class="pi">:</span>
        <span class="na">directories</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">$HOME/.cache/go-build</span>
          <span class="pi">-</span> <span class="s">$HOME/gopath/pkg/mod</span>

    <span class="pi">-</span> <span class="na">os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">go</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.10.x"</span>
      <span class="na">cache</span><span class="pi">:</span>
        <span class="na">directories</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">$HOME/.cache/go-build</span>
          <span class="pi">-</span> <span class="s">$HOME/gopath/pkg/mod</span>

    <span class="pi">-</span> <span class="na">os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">go</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.11.x"</span>
      <span class="na">sudo</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">cache</span><span class="pi">:</span>
        <span class="na">directories</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">$HOME/.cache/go-build</span>
          <span class="pi">-</span> <span class="s">$HOME/gopath/pkg/mod</span>

    <span class="pi">-</span> <span class="na">os</span><span class="pi">:</span> <span class="s">osx</span>
      <span class="na">go</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.11.x"</span>
      <span class="na">cache</span><span class="pi">:</span>
        <span class="na">directories</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">$HOME/Library/Caches/go-build</span>
          <span class="pi">-</span> <span class="s">$HOME/gopath/pkg/mod</span>
</code></pre></div></div>

<p>After a successful build, Travis will then archive both directories, and
extract them again for the next test run. Indeed, this speeds up running the
tests a great deal (depending on how much code has changed):</p>

<p><img src="/assets/travis-ci-with-build-cache.png" alt="Build Times on Travis CI With Caching Build Cache" /></p>

<p>You can see in the screenshot above that the build time for Go 1.9 wasn’t
reduced at all since it does not have the build cache feature.</p>

<p>AppVeyor also has a <a href="https://www.appveyor.com/docs/build-cache/">build cache
feature</a>, it can be enabled by
specifying the list of directories to cache in the <code class="highlighter-rouge">appveyor.yml</code> like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">cache</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">%LocalAppData%\go-build'</span>
</code></pre></div></div>

<p>For restic, the build cache is not so relevant on AppVeyor, since we’re only
using it to run our integration tests on Windows and don’t run any
cross-compilation.</p>

<p>We hope that the build cache does not become too large, its size is limited for
both Travis and AppVeyor. The Go compiler will <a href="https://golang.org/cmd/go/#hdr-Build_and_test_caching">delete files which haven’t been
used recently</a>, so we
hope this is enough to keep the cache size small. We’ll keep you posted when we
discover any problems with this approach.</p>

<p>Let us know what you think in the comments (which are hosted in <a href="https://forum.restic.net">our
forum</a>)!</p>

</div>

<h2>Comments</h2>
<div id='discourse-comments'></div>

<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://forum.restic.net/',
                     discourseEmbedUrl: 'https://restic.net/blog/2018-09-02/travis-build-cache' };

  (function() {
    var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2019-01-01/new-infrastructure">
            New Year, New Infrastructure!
            <small>01 Jan 2019</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2018-10-13/restic-0.9.3-released">
            restic 0.9.3 released
            <small>13 Oct 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2018-09-09/GitHub-issue-templates">
            Configuring GitHub Issue Templates
            <small>09 Sep 2018</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

    <a href="https://github.com/restic/restic" class="desktop"><img style="position: fixed; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>

  </body>
</html>
